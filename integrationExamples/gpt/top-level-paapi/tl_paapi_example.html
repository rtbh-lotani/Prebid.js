<html>
<head>
    <script async src="../../../../build/dev/prebid.js"></script>
    <script>
        // intercept navigator.runAdAuction and print parameters to console
        (() => {
            var originalRunAdAuction = navigator.runAdAuction;
            navigator.runAdAuction = function (...args) {
                console.log('%c runAdAuction', 'background: cyan; border: 2px; border-radius: 3px', ...args);
                return originalRunAdAuction.apply(navigator, args);
            };
        })();
    </script>

    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>

    <script>
        var openxBidValue = Number(document.location.search.replace(/.*[&?]openxbid=([\d.]+)(?:&.*|$)/, '$1'));
        var pageFloorValue = Number(document.location.search.replace(/.*[&?]floor=([\d.]+)(?:&.*|$)/, '$1'));
        // console.log('openxBidValue=', openxBidValue)
        openxBidValue ||= .15;
        pageFloorValue ||= 0.01;
        // console.log('openxBidValue=', openxBidValue)
        var rtbhouseBidValue = Number(document.location.search.replace(/.*[&?]rtbhousebid=([\d.]+)(?:&.*|$)/, '$1'));
        rtbhouseBidValue ||= .15
        
        // var openxBidValue = 0.10 + 0.05*Math.random();
        var bidders = [];
        document.location.search.replaceAll(/[&?]bidders=([\w,]+)/g, (match, p1) => { bidders.push(p1) ; return  });
        // var bidders = document.location.search.replace(/.*[&?]bidders=([\w,]+)/, '$1').split(',');
        // if(!bidders.length) bidders = ['openx', 'rtbhouse'];
        // console.log('Found bidders:', bidders)
        var FAILSAFE_TIMEOUT = 3300;
        var PREBID_TIMEOUT = 3000;
        var adUnits = [{
                code: 'div-1',
                mediaTypes: {
                    banner: {
                        sizes: [[300, 250]],
                    }
                },
                ortb2Imp: {
                    ext: {
                        ae: 1
                    }
                },
                bids: [
                    {
                        bidder: 'openx',
                        params: {
                            unit: '538703464',
                            response_template_name: 'test_banner_ad',
                            test: true,
                            delDomain: 'sademo-d.openx.net'
                        }
                    },
                    {
                        bidder: 'rtbhouse',
                        params: {
                            region: 'prebid-eu',
                            publisherId: 'FLEDGE-test'
                        }
                    }

                ].filter(b => bidders.includes(b.bidder)),
            }
            ]
        ;

        var pbjs = pbjs || {};
        pbjs.que = pbjs.que || [];

        var googletag = googletag || {};
        googletag.cmd = googletag.cmd || [];
        googletag.cmd.push(function () {
            googletag.pubads().disableInitialLoad();
        });

        pbjs.que.push(function () {
            pbjs.setBidderConfig({
                bidders: ["rtbhouse"],
                config: {
                    fledgeEnabled: true,
                    fledgeConfig: {
                        seller: 'https://fledge-ssp.creativecdn.com',
                        decisionLogicUrl: 'https://fledge-ssp.creativecdn.com/component-seller-prebid.js',
                        // 'seller': 'https://privacysandbox.openx.net',
                        // 'decisionLogicUrl': 'https://privacysandbox.openx.net/fledge/decision-logic-component.js',
                                        
                        interestGroupBuyers: ['https://f.creativecdn.com'],
                        sellerTimeout: 100
                    }
                }
            });
            pbjs.setConfig({
                debug: true,
                paapi: {
                    enabled: true,
                    gpt: {
                        autoconfig: false
                    }
                },
                debugging: {
                    enabled: true,
                    intercept: [
                        {
                            when: {
                                bidder: 'openx',
                            },
                            then: {
                                cpm: pageFloorValue,
                                currency: 'USD'
                            },
                            paapi() {
                                return [
                                    {
                                        'seller': 'https://privacysandbox.openx.net',
                                        'decisionLogicURL': 'https://privacysandbox.openx.net/fledge/decision-logic-component.js',
                                        'sellerSignals': {
                                            'floor': 0.01,
                                            'currency': 'USD',
                                            'auctionTimestamp': new Date().getTime(),
                                            'publisherId': '537143056',
                                            'adUnitId': '538703464'
                                        },
                                        'interestGroupBuyers': [
                                            'https://privacysandbox.openx.net'
                                        ],
                                        'perBuyerSignals': {
                                            'https://privacysandbox.openx.net': {
                                                'bid': openxBidValue
                                                // 'bid': 0.15
                                            }
                                        },
                                        'sellerCurrency': 'USD'
                                    }
                                ];
                            }
                        },
                        // {
                        //     when: {
                        //         bidder: 'rtbhouse',
                        //     },
                        //     then: {
                        //         cpm: pageFloorValue,
                        //         currency: 'USD'
                        //     },
                        //     paapi() {
                        //         return [
                        //             {
                        //                 'seller': 'https://fledge-ssp.creativecdn.com',
                        //                 'decisionLogicURL': 'https://fledge-ssp.creativecdn.com/component-seller-prebid.js',
                        //                 // 'seller': 'https://privacysandbox.openx.net',
                        //                 // 'decisionLogicURL': 'https://privacysandbox.openx.net/fledge/decision-logic-component.js',
                        //                 'sellerSignals': {
                        //                     'floor': 0.01,
                        //                     'currency': 'USD',
                        //                     // 'currency': 'EUR',
                        //                     // 'auctionTimestamp': new Date().getTime(),
                        //                     'region': 'prebid-eu',
                        //                     'publisherId': 'FLEDGE-test'
                        //                 },
                        //                 'interestGroupBuyers': [
                        //                     'https://f.creativecdn.com'
                        //                 ],
                        //                 'perBuyerSignals': {
                        //                     'https://f.creativecdn.com': {
                        //                         // 'bid': 2
                        //                         'bid': rtbhouseBidValue
                        //                     }
                        //                 },
                        //                 'sellerCurrency': 'USD'
                        //                 // 'sellerCurrency': 'EUR'
                        //             }
                        //         ];
                        //     }
                        // }
                    ]
                },
            });

            pbjs.addAdUnits(adUnits);
            pbjs.requestBids({
                bidsBackHandler: sendAdserverRequest,
                timeout: PREBID_TIMEOUT
            });
        });

        function raa() {
            const conf = pbjs.getPAAPIConfig();
            console.log('PAAPI config:', conf)
            return Promise.all(
                Object.entries(conf)
                    .map(([adUnitCode, auctionConfig]) => {

                        return navigator.runAdAuction({
                            // seller: window.location.origin,
                            // decisionLogicURL: new URL('decisionLogic.js', window.location).toString(),
                            seller: 'https://sphenoid-stripe-snarl.glitch.me',
                            decisionLogicURL: 'https://sphenoid-stripe-snarl.glitch.me/ssp/decisionLogic.js',
                            resolveToConfig: false,
                            ...auctionConfig
                        }).then(urn => {
                            if (urn) {
                                // if we have a paapi winner, replace the adunit div
                                // with an iframe that renders it
                                const iframe = document.createElement('iframe');
                                Object.assign(iframe, {
                                    src: urn,
                                    frameBorder: 0,
                                    scrolling: 'no',
                                }, auctionConfig.requestedSize);
                                const div = document.getElementById(adUnitCode);
                                div.parentElement.insertBefore(iframe, div);
                                div.remove();
                                return true;
                            }
                        });
                    })
            ).then(won => won.every(el => el));
        }

        function sendAdserverRequest() {
            if (pbjs.adserverRequestSent) return;
            pbjs.adserverRequestSent = true;
            raa().then((allPaapi) => {
                if (!allPaapi) {
                    googletag.cmd.push(function () {
                        pbjs.que.push(function () {
                            pbjs.setTargetingForGPTAsync();
                            googletag.pubads().refresh();
                        });
                    });
                }
            });
        }

        setTimeout(function () {
            sendAdserverRequest();
        }, FAILSAFE_TIMEOUT);

        googletag.cmd.push(function () {
            googletag.defineSlot('/19968336/header-bid-tag-0', [[300, 250], [300, 600]], 'div-1').addService(googletag.pubads());

            googletag.pubads().enableSingleRequest();
            googletag.enableServices();
        });
    </script>
</head>

<body>
<h2>Standalone PAAPI Prebid.js Example</h2>
<p>Start local server with:</p>
<code>gulp serve-fast --https</code>
<p>Chrome flags:</p>
<script>
    var chromeOptions = {
        'enable-features': 'CookieDeprecationFacilitatedTesting:label/treatment_1.2/force_eligible/true',
        'privacy-sandbox-enrollment-overrides': document.location.origin
    }
    document.write('<code>' +
    Object.entries(chromeOptions).map(([key, value]) => `--${key}=${value}`).join(' ')
    + '</code>');
</script>
<!-- <code>--enable-features=CookieDeprecationFacilitatedTesting:label/treatment_1.2/force_eligible/true
    --privacy-sandbox-enrollment-overrides=https://localhost:9999</code> -->
<p>Join OpenX interest group at <a href="https://privacysandbox.openx.net/fledge/advertiser">https://privacysandbox.openx.net/fledge/advertiser</a>
</p>
<p>Join RTB House interest group at <a href="https://rtbfashion.net">https://rtbfashion.net</a>
</p>
<form method="get" action="">
    <fieldset>
    <label><input type="checkbox" name="bidders" value="openx" onchange="control(this,'openxbid')"> OpenX</label>
    <span id="openxbid">
        &RightArrow; OpenX mocked bid value: <input type="text" name="openxbid">
    </span>
    <br>
    <!-- <label><input type="checkbox" name="bidders" value="rtbhouse" onchange="control(this,'rtbhousebid')"> RTB House</label> -->
    <label><input type="checkbox" name="bidders" value="rtbhouse"> RTB House</label>
    <!-- <span id="rtbhousebid">
        &RightArrow; RTB House mocked bid value: <input type="text" name="rtbhousebid">
    </span> -->
    <br>
    <label id="floor">Page floor value: <input type="text" name="floor"></label>
    <br>
    <input type="submit" value="Update">
    </fieldset>
    <p>
        RTB House uses a true dynamic bid evaluating. To find out what was the recent bid value, filter the console by 
        <code>Buyer: https://f.creativecdn.com</code> phrase and find the <code>Context: { bid }</code> or 
        <code>Result: { desirability }</code>
    </p>
</form>
<script>
    [...document.querySelectorAll('input[name=bidders]')].forEach(c => {
        c.checked = bidders.includes(c.value);
        c.onchange && c.onchange();
    });
    document.querySelector('input[name=openxbid]').value = openxBidValue || '';
    // document.querySelector('input[name=rtbhousebid]').value = rtbhouseBidValue || '';
    document.querySelector('input[name=floor]').value = pageFloorValue || '';
    function control(checkbox, inputName) {
        checkbox.form[inputName].disabled = !checkbox.checked;
        document.getElementById(inputName).style.display = checkbox.checked ? '' : 'none';
    }
</script>
<h5>Div-1</h5>
<div id='div-1' style='min-width: 300px; min-height: 250px;'>
    <script type='text/javascript'>
        googletag.cmd.push(function () {
            googletag.display('div-1');
        });
    </script>
</div>

</body>
</html>
